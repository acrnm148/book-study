## 3.1

## 3.2

## 3.3 CrudRepository 인터페이스를 사용해서 CRUD 연산을 수행하는 방법
📌 spring-data와 spring-data-commons 모듈
```
[build.gradle]
...
implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
implementation 'org.springframework.boot:spring-boot-starter-data-redis'
...
```
- 스프링 프레임워크만 보더라도 core, test, MVC 등 여러 모듈이 있고
  스프링 프레임워크, 스프링 부트, 스프링 데이터, 스프링 클라우드 등 여러 프로젝트들이 존재함.
- [공식문서](https://spring.io/projects/spring-data)
  
![image](https://github.com/acrnm148/book-study/assets/67724306/71211ea7-f2da-4af5-af3a-51b6b844d21b)

- spring-data
  - 기본 데이터 저장소(DB)에 대한 특성은 유지하며, 데이터 접근 방법에 대해 친숙한 접근 방법을 제시하는 Spring 기반 프로그래밍 모델.
  - 각각의 데이터베이스에 대해 만들어진 특정한 하위 프로젝트들로 구성된 우산형 프로젝트.
  - CRUD 동작이 필요. Spring data는 Repository라는 인터페이스를 제공, 각 데이터 저장소는 이 Repository를 구현하여 자신의 데이터 저장소에 맞는 repository를 제공한다.
    - ex) JpaRepository, MongoRepository ...
  - 구성
  
![image](https://github.com/acrnm148/book-study/assets/67724306/7a75017a-91ee-45b9-8b85-c40bacf5fb53)
![image](https://github.com/acrnm148/book-study/assets/67724306/38948101-730d-4e9b-a1c8-d8f586f8d8a0)
- [spring-data-commons](https://github.com/spring-projects/spring-data-commons/tree/main/src/main/java/org/springframework/data/repository) : Repsotiroy 인터페이스, CrudRepository, PagingAndSortingRepository, ...
- 하위 프로젝트들 : spring-data-jpa, spring-data-redis ...

❓ [Starters](https://github.com/spring-projects/spring-boot/tree/main/spring-boot-project/spring-boot-starters)
  - spring-boot-starter는 응용 프로그램에 종속성을 포함시킴으로써 필요한 모든 관련 기술을 원스톱으로 이용할 수 있는 '편리한 종속성 세트'


### 1. Repository 인터페이스
- `spring-data-commons` 모듈에 포함되어 있음.
- spring data repository 모듈은 Repository 인터페이스를 사용해서 데이터 소스 접근을 추상화
- Repository 인터페이스는 `도메인 클래스` + `식별자 타입`을 필요로 한다.
  - 도메인 클래스 = DB에 저장되어 관리되는 비즈니스 엔티티 클래스
- 메서드나 상수를 포함 X, 오직 객체의 런타임 타입 정보만을 알려주는 마커 인터페이스

### 2. CrudRepository
- Repository 인터페이스를 상속받은 하위 인터페이스
- CRUD 연산을 포함하고 있음.
- 제너릭 타입 T : 도메인 클래스, ID : 도메인 클래스의 식별자
```java
@NoRepositoryBean
public interface CrudRepository<T, ID> extends Repository<T, ID> {
	<S extends T> S save(S entity);
	<S extends T> Iterable<S> saveAll(Iterable<S> entities);
	Optional<T> findById(ID id);
	boolean existsById(ID id);
	Iterable<T> findAll();
	Iterable<T> findAllById(Iterable<ID> ids);
	long count();
	void deleteById(ID id);
	void delete(T entity);
	void deleteAllById(Iterable<? extends ID> ids);
	void deleteAll(Iterable<? extends T> entities);
	void deleteAll();
}
```

### 3. PagingAndSortingRepository 인터페이스
- CrudRepository 인터페이스를 상속받는 인터페이스
- 페이징, 정렬 기능 포함
```java
@NoRepositoryBean
public interface PagingAndSortingRepository<T, ID> extends Repository<T, ID> {
	Iterable<T> findAll(Sort sort);
	Page<T> findAll(Pageable pageable);
}
```


## 3.3.1 스프링 데이터 JPA를 사용해서 도메인 객체를 RDBMS에서 관리
- 도메인 클래스
```java
```
- 주요 annotation
```java
@Entity : JPA로 관리되는 엔티티 클래스
@Table : 해당 엔티티가 저장되는 테이블 이름 (지정해주지 않으면 엔티티 이름을 테이블 이름으로 사용.)
@Column : 자바 필드 정보와 테이블 컬럼 정보를 매핑 => camelCase라면 컬럼명은 camel_case 언더스코어를 사용해서 만들어진다.
@Id : 테이블의 PK (유일한 데이터로 식별할 수 있는 식별자) => ❓JPA에 의해 자동 생성되므로 생성자에는 id필드가 포함돼있지 않음.
@GeneratedValue : 식별자로 사용되는 id값이 자동 생성됨(개발자가 지정X) => 자동 생성 전략을 지정할 수 있음.
	1. Table: 키 테이블을 따로 만들고, 이 테이블에서 키를 생성하여 이를 PK로 사용
	2. Identity: PK컬럼에서 생성된 값을 PK로 사용
	3. Sequence : 시퀀스를 사용해서 키 생성, 이를 PK로 사용
	4. Auto: JPA구현체가 기본 키 생성 방식을 스스로 결정
```
- 스프링 데이터 레포지토리
```java
```
- 주요 annotation
```java
@Repository
- 두 가지 목적
1. 자동 감지: @Component 어노테이션을 포함하고 있어 컴포넌트 스캔 과정에서 탐지됨.
2. 예외 변환: Exception은 JPA 구현체(하이버네이트, 이클립스링크, ...)에 따라 달라짐
	=> 각각 다른 예외를 하나하나 처리해줄 수 없으므로 이를 변환하는 추가 작업이 필요함 => @Repository으로 해결
	=> @Repository는 Exception을 DataAccessException으로 변환해줌 => DataAccessException만 처리해주면 됨.
```

- application.yml
```java
spring.jpa.hibernate.ddl-auto=create
=> ddl-auto는 하이버네이트에서만 동작하는 프로퍼티 (다른 구현체: spring.jpa.generate-ddl 프로퍼티를 사용)
1. none: DDL자동생성 기능 비활성화
2. validate: 실제 DB스키마와 자동 생성되는 DDL을 비교 검증해서 차이가 있으면 DB반영X + 애플리케이션 시작 시 에러 발생
3. update: 실제 DB스키마와 자동 생성되는 DDL을 비교 검증해서 차이가 있으면 DDL 기준으로 변경사항을 DB에 반영
4. create: 기존에 존재하던 스키마와 데이터를 삭제하고 스키마를 새로 생성
5. create-drop: 기존에 존재하던 스키마와 데이터를 삭제하고 스키마 새로 생성 + 애플리케이션 종료 시 스키마와 데이터 삭제
```



## 3.3.2 커스텀 스프링 데이터 레포지토리를 만들어서 RDBMS에서 도메인 객체 관리

